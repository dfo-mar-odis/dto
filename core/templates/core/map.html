{% extends 'base_map.html' %}
{% load static %}

{% block content %}
    <div class="row mt-2">
        <div class="col">
            <div class="card h-100">
                <div class="card-header">
                    <div class="card-title"><h2>MPA Description</h2></div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-2"><b>MPA Name:</b></div>
                        <div class="col" id="mpa_name"></div>
                    </div>
                    <div class="row">
                        <div class="col-2"><b>MPA Zone:</b></div>
                        <div class="col" id="mpa_zone"></div>
                    </div>
                    <div class="row">
                        <div class="col-2"><b>MPA URL:</b></div>
                        <div class="col" id="mpa_url"><a></a></div>
                    </div>
                    <div class="row">
                        <div class="col-2"><b>Regulation:</b></div>
                        <div class="col" id="mpa_regulation"><a></a></div>
                    </div>
                    <div class="row">
                        <div class="col-2"><b>km^2:</b></div>
                        <div class="col" id="mpa_km2"></div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-auto">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">
                                        <h6>Tolerance</h6>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <label for="dial_max" class="form-label">Max</label>
                                    <input type="number" class="form-control" id="tolerance_max" step="0.5" name="max_risk"/>

                                    <label for="dial_min" class="form-label">Min</label>
                                    <input type="number" class="form-control" id="tolerance_min" step="0.5" name="min_risk"/>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="row">
                                <div class="col text-center">
                                    <label for="riskdial" class="text-center">Risk Dial</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col text-center">
                                    <input id="riskdial" type="text" class="dial"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-auto">
            <div class="card h-100">
                <div class="card-body">
                    <div class="folium-map mt-2" id="map"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-2 h-100">
        <div class="card-body" style="height: 300px">
            <div class="d-flex justify-content-center">
                <div id="loading_chart"></div>
            </div>
            <canvas id="mpa_time_series_chart"></canvas>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ mpas|json_script:"mpas_json" }}
    <script>
        let tolerance_min = 2;
        let tolerance_max = 5;

        $(function($) {
            let $min_dial = $("#tolerance_min");
            let $max_dial = $("#tolerance_max");
            $min_dial.val(tolerance_min);
            $min_dial.on('input', function(e) {
                get_color(dial_cur);

                min_indicator.value = tolerance_min = $(this).val();
                timeseries_chart.update();
            })
            $max_dial.val(tolerance_max);
            $max_dial.on('input', function(e) {
                get_color(dial_cur);

                max_indicator.value = tolerance_max = $(this).val();
                timeseries_chart.update();
            })
        });

        function clear_timeseries() {
            ts_title = '';
            qs_data = [];

            dial_min = 0;
            dial_max = 0;
            dial_cur = 0;
            configure_dial();

            ts_labels = [];
            ts_data = [];
            date_indicator.value = "undefined";
            update_chart();
        }

        function get_timeseries(id) {
            $.ajax({
                method: "GET",
                url: {%  url 'timeseries' %} +'?mpa=' + id,
                beforeSend: function() {
                    $("#loading_chart").addClass("loader");
                    $("#mpa_time_series_chart").hide();
                },
                success: function (data) {
                    ts_title = data.name;
                    qs_data = data.data;

                    // Min, Max and Average of the time series come from the server
                    dial_min = data.min;
                    dial_max = data.max;
                    dial_cur = data.avg;
                    configure_dial();

                    ts_labels = $.map(qs_data, function (value, key) {
                        return Date.parse(value.date)
                    })
                    ts_data = $.map(qs_data, function (value, key) {
                        return value.temp
                    })
                    update_chart();
                },
                error: function (error_data) {
                    console.log("error");
                    console.log(error_data);
                },
                complete: function() {
                    $("#loading_chart").removeClass("loader");
                    $("#mpa_time_series_chart").show();
                }
            });
        }

        let map = L.map('map').setView([44.666830, -59.631500], 6)

        L.tileLayer(
            "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
            {
                "attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors",
                "detectRetina": false,
                "maxNativeZoom": 19,
                "maxZoom": 19,
                "minZoom": 0,
                "noWrap": false,
                "opacity": 1,
                "subdomains": "abc",
                "tms": false
            }
        ).addTo(map);

        let mpas = JSON.parse(document.getElementById('mpas_json').textContent)

        let multiPolygonOptions = {color: 'red', weight: 8};

        let selectedLayer = null;
        mpas.forEach(mpa => {
            let json = JSON.parse(mpa)
            let geo_obj = L.geoJSON(json,
                {
                    style: function (feature) {
                        return {
                            fillColor: feature.style.color,
                            fillOpacity: '0.8',
                        }
                    }
                });
            geo_obj.on('click', function (e) {
                if (selectedLayer) {
                    selectedLayer.setStyle({fillColor: selectedLayer.feature.style.color});
                }

                selectedLayer = e.layer
                selectedLayer.setStyle({fillColor: "#ffff00"});

                let feature = selectedLayer.feature
                clear_timeseries();
                get_timeseries(feature.id);
                $("#mpa_name").text(feature.properties.name);
                $("#mpa_zone").text(feature.properties.zone);

                let $mpa_url = $("#mpa_url a");
                $mpa_url.attr("href", feature.properties.url)
                $mpa_url.text(feature.properties.url);

                let $regulation = $("#mpa_regulation a");
                $regulation.attr("href", feature.properties.regulation)
                $regulation.text(feature.properties.regulation);

                $("#mpa_reglement").text(feature.properties.reglement);
                $("#mpa_km2").text(feature.properties.km2);
            });
            geo_obj.addTo(map)
        });

    </script>
    <script src="{% static 'js/custom_dial.js' %}"></script>
    <script src="{% static 'js/custom_chart.js' %}"></script>

{% endblock %}